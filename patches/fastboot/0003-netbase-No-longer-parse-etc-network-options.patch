From 62db1bf1bc2676aaa5ad7e9db46d986645ba5d94 Mon Sep 17 00:00:00 2001
From: Klaus Kurzmann <mok@fluxnetz.de>
Date: Sat, 13 Dec 2008 10:37:46 +0100
Subject: [PATCH] netbase: No longer parse /etc/network/options.

Author: Chia-I Wu <olv@openmoko.com>
Signed-off-by: Klaus Kurzmann <mok@fluxnetz.de>
---
 packages/netbase/netbase/openmoko/init    |   46 +++++++++++++++++++++++++++++
 packages/netbase/netbase/openmoko/options |    1 +
 packages/netbase/netbase_4.21.bb          |    2 +-
 3 files changed, 48 insertions(+), 1 deletions(-)
 create mode 100644 packages/netbase/netbase/openmoko/init
 create mode 100644 packages/netbase/netbase/openmoko/options

diff --git a/packages/netbase/netbase/openmoko/init b/packages/netbase/netbase/openmoko/init
new file mode 100644
index 0000000..32810dc
--- /dev/null
+++ b/packages/netbase/netbase/openmoko/init
@@ -0,0 +1,46 @@
+#!/bin/sh
+#
+# manage network interfaces and configure some networking options
+
+PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
+
+if ! [ -x /sbin/ifup ]; then
+    exit 0
+fi
+
+case "$1" in
+    start)
+        echo -n "Configuring network interfaces... "
+        ifup -a
+	echo "done."
+	;;
+    stop)
+        if sed -n 's/^[^ ]* \([^ ]*\) \([^ ]*\) .*$/\1 \2/p' /proc/mounts |
+          grep -q "^/ nfs$"; then
+            echo "NOT deconfiguring network interfaces: / is an NFS mount"
+        elif sed -n 's/^[^ ]* \([^ ]*\) \([^ ]*\) .*$/\1 \2/p' /proc/mounts |
+          grep -q "^/ smbfs$"; then
+            echo "NOT deconfiguring network interfaces: / is an SMB mount"
+	elif sed -n 's/^[^ ]* \([^ ]*\) \([^ ]*\) .*$/\2/p' /proc/mounts |
+          grep -qE '^(nfs|smbfs|ncp|coda)$'; then
+            echo "NOT deconfiguring network interfaces: network shares still mounted."
+        else
+            echo -n "Deconfiguring network interfaces... "
+            ifdown -a
+	    echo "done."
+        fi
+	;;
+    force-reload|restart)
+        echo -n "Reconfiguring network interfaces... "
+        ifdown -a
+        ifup -a
+	echo "done."
+	;;
+    *)
+	echo "Usage: /etc/init.d/networking {start|stop|restart|force-reload}"
+	exit 1
+	;;
+esac
+
+exit 0
+
diff --git a/packages/netbase/netbase/openmoko/options b/packages/netbase/netbase/openmoko/options
new file mode 100644
index 0000000..1cbffcb
--- /dev/null
+++ b/packages/netbase/netbase/openmoko/options
@@ -0,0 +1 @@
+# DEPRECATED by /etc/sysctl.conf
diff --git a/packages/netbase/netbase_4.21.bb b/packages/netbase/netbase_4.21.bb
index a0baa81..293b593 100644
--- a/packages/netbase/netbase_4.21.bb
+++ b/packages/netbase/netbase_4.21.bb
@@ -2,7 +2,7 @@ DESCRIPTION = "This package provides the necessary \
 infrastructure for basic TCP/IP based networking."
 SECTION = "base"
 LICENSE = "GPL"
-PR = "r29"
+PR = "r29.1"
 
 inherit update-rc.d
 
-- 
1.6.0.4

